name: Build (On-Demand) & Optional Deploy to Nginx

on:
  workflow_dispatch:
    inputs:
      deploy:
        description: "Dopo il build, fare deploy via SSH su nginx?"
        type: choice
        options: ["no", "yes"]
        default: "no"
      target_path:
        description: "Web root remoto (usato solo se deploy=yes). Es: /var/www/mybirme"
        required: false

permissions:
  contents: read

jobs:
  build:
    name: Build & Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install deps (ci)
        run: npm ci

      - name: Typecheck (facoltativo)
        run: npm run typecheck --if-present

      - name: Lint (facoltativo)
        run: npm run lint --if-present

      - name: Build (Vite)
        run: npm run build

      - name: Crea tar.gz per nginx
        run: |
          APP_NAME=mybirme
          TAR_NAME="$APP_NAME-${GITHUB_REF_NAME}-${GITHUB_SHA}.tar.gz"
          tar -C dist -czf "$TAR_NAME" .
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV

      - name: Upload artifacts (dist + tar.gz)
        uses: actions/upload-artifact@v4
        with:
          name: mybirme-dist-${{ github.sha }}
          path: |
            dist/**
            ${{ env.TAR_NAME }}
          retention-days: 30

  deploy:
    name: Deploy to Nginx (SSH/rsync)
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event.inputs.deploy == 'yes' }}

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: mybirme-dist-${{ github.sha }}
          path: ./artifact

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.NGINX_SSH_KEY }}
          REMOTE_HOST:     ${{ secrets.NGINX_HOST }}
          REMOTE_USER:     ${{ secrets.NGINX_USERNAME }}
        run: |
          install -m 700 -d ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$REMOTE_HOST" >> ~/.ssh/known_hosts

      - name: Rsync dist/ -> server
        env:
          REMOTE_HOST: ${{ secrets.NGINX_HOST }}
          REMOTE_USER: ${{ secrets.NGINX_USERNAME }}
          REMOTE_PATH: ${{ github.event.inputs.target_path || '/var/www/mybirme' }}
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/id_rsa" ./artifact/dist/ "$REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH/"

      # (Opzionale) fix permessi / reload, se necessario
      - name: Post-deploy (opzionale)
        if: always()
        env:
          REMOTE_HOST: ${{ secrets.NGINX_HOST }}
          REMOTE_USER: ${{ secrets.NGINX_USERNAME }}
          REMOTE_PATH: ${{ github.event.inputs.target_path || '/var/www/mybirme' }}
        run: |
          ssh -i ~/.ssh/id_rsa "$REMOTE_USER@$REMOTE_HOST" \
            "sudo chown -R www-data:www-data '$REMOTE_PATH' || true"
